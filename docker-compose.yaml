services:
  postgres:
    image: postgres:18-alpine
    container_name: colaba-postgres
    env_file: .env
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh
    networks:
      - colaba-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d ${USER_DB_NAME:-user_db} -U ${SPRING_DATASOURCE_USERNAME:-colaba_user}" ]
      interval: 5s
      timeout: 5s
      retries: 10

  discovery-server:
    build:
      context: .
      target: discovery-server
    container_name: colaba-discovery
    environment:
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT:-8761}
      EUREKA_HOSTNAME: ${EUREKA_HOSTNAME:-discovery-server}
      SERVER_PORT: ${DISCOVERY_SERVER_PORT:-8761}
    env_file: .env
    ports:
      - "${DISCOVERY_SERVER_PORT:-8761}:${DISCOVERY_SERVER_PORT:-8761}"
    networks:
      - colaba-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${DISCOVERY_SERVER_PORT:-8761}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  config-server:
    build:
      context: .
      target: config-server
    container_name: colaba-config
    environment:
      CONFIG_REPO_URI: https://github.com/COLABA-Tech/colaba-config-repo.git
      EUREKA_CLIENT_ENABLED: false
    env_file: .env
    ports:
      - "${CONFIG_SERVER_PORT:-8888}:${CONFIG_SERVER_PORT:-8888}"
    networks:
      - colaba-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${CONFIG_SERVER_PORT:-8888}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  api-gateway:
    build:
      context: .
      target: api-gateway
    container_name: colaba-gateway
    environment:
      API_GATEWAY_PORT: ${API_GATEWAY_PORT:-8080}
    ports:
      - "${API_GATEWAY_PORT:-8080}:${API_GATEWAY_PORT:-8080}"
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy

  user-service:
    build:
      context: .
      target: user-service
    container_name: colaba-user-service
    hostname: user-service
    env_file: .env
    ports:
      - "${USER_SERVICE_PORT:-8081}:${USER_SERVICE_PORT:-8081}"
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      postgres:
        condition: service_healthy

  project-service:
    build:
      context: .
      target: project-service
    container_name: colaba-project-service
    hostname: project-service
    env_file: .env
    ports:
      - "${PROJECT_SERVICE_PORT:-8082}:${PROJECT_SERVICE_PORT:-8082}"
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      postgres:
        condition: service_healthy

  task-service:
    build:
      context: .
      target: task-service
    container_name: colaba-task-service
    hostname: task-service
    env_file: .env
    ports:
      - "${TASK_SERVICE_PORT:-8083}:${TASK_SERVICE_PORT:-8083}"
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      postgres:
        condition: service_healthy

volumes:
  postgres_data:

networks:
  colaba-network:
    driver: bridge