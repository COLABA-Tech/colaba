services:
  postgres:
    image: postgres:18-alpine
    env_file: .env
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh
    networks:
      - colaba-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d ${USER_DB_NAME:-user_db} -U ${SPRING_DATASOURCE_USERNAME:-colaba_user}" ]
      interval: 30s
      timeout: 10s
      retries: 5

  discovery-server:
    build:
      context: .
      target: discovery-server
    environment:
      DISCOVERY_SERVER_PORT: ${DISCOVERY_SERVER_PORT:-8761}
      EUREKA_HOSTNAME: ${EUREKA_HOSTNAME:-discovery-server}
      SERVER_PORT: ${DISCOVERY_SERVER_PORT:-8761}
    env_file: .env
    ports:
      - "${DISCOVERY_SERVER_PORT:-8761}:${DISCOVERY_SERVER_PORT:-8761}"
    networks:
      - colaba-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${DISCOVERY_SERVER_PORT:-8761}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5

  config-server:
    build:
      context: .
      target: config-server
    env_file: .env
    ports:
      - "${CONFIG_SERVER_PORT:-8888}:${CONFIG_SERVER_PORT:-8888}"
    networks:
      - colaba-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${CONFIG_SERVER_PORT:-8888}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5

  api-gateway:
    build:
      context: .
      target: api-gateway
    environment:
      API_GATEWAY_PORT: ${API_GATEWAY_PORT:-8080}
    ports:
      - "${API_GATEWAY_PORT:-8080}:${API_GATEWAY_PORT:-8080}"
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${MANAGEMENT_PORT:-8081}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5

  user-service:
    build:
      context: .
      target: user-service
    hostname: user-service
    env_file: .env
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${MANAGEMENT_PORT:-8081}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5

  project-service:
    build:
      context: .
      target: project-service
    hostname: project-service
    env_file: .env
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${MANAGEMENT_PORT:-8081}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5

  task-service:
    build:
      context: .
      target: task-service
    hostname: task-service
    env_file: .env
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${MANAGEMENT_PORT:-8081}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5

  auth-service:
    build:
      context: .
      target: auth-service
    hostname: auth-service
    env_file: .env
    networks:
      - colaba-network
    depends_on:
      config-server:
        condition: service_healthy
      discovery-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${MANAGEMENT_PORT:-8081}/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  postgres_data:

networks:
  colaba-network:
    driver: bridge